<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager - Financial Portfolio Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }

        /* Modern Grows-style circular icons */
        .stock-icon-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }
        .stock-icon-circle.large {
            width: 64px;
            height: 64px;
            font-size: 24px;
        }
        .stock-icon-circle.small {
            width: 36px;
            height: 36px;
            font-size: 14px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar-logo {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .sidebar-logo .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-logo .logo-text { color: #fff; font-size: 18px; font-weight: 600; }
        .sidebar-logo .logo-subtext { color: rgba(255,255,255,0.5); font-size: 11px; }

        /* Modern sidebar nav with icons */
        .sidebar-nav { padding: 20px 0; }
        .sidebar-nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s;
            gap: 14px;
            margin: 4px 12px;
            border-radius: 12px;
        }
        .sidebar-nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
            transform: translateX(4px);
        }
        .sidebar-nav-item.active {
            background: linear-gradient(90deg, rgba(59,130,246,0.3), transparent);
            color: #3b82f6;
            border-left: 3px solid #3b82f6;
        }
        .sidebar-nav-item .nav-icon {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .sidebar-nav-item span { font-size: 14px; font-weight: 500; }

        .main-panel { margin-left: 260px; min-height: 100vh; background: #f1f5f9; }

        /* Card styles */
        .stat-card {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Stock positive/negative */
        .stock-up { color: #10b981; }
        .stock-down { color: #ef4444; }

        /* Gain/loss badges */
        .gain-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .gain-indicator.up { background: rgba(16,185,129,0.1); color: #10b981; }
        .gain-indicator.down { background: rgba(239,68,68,0.1); color: #ef4444; }

        .section-title { font-size: 20px; font-weight: 600; color: #1e293b; }

        .search-box {
            background: #fff;
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .search-box input { border: none; outline: none; flex: 1; font-size: 14px; }

        .stock-table-row:hover { background: #f8fafc; }

        @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .live-indicator { animation: pulse-green 2s infinite; }
        .live-indicator.down { animation: pulse-red 2s infinite; color: #ef4444; }

        .market-status { display: flex; align-items: center; gap: 8px; }
        .market-status.open { color: #10b981; }
        .market-status.closed { color: #ef4444; }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
        .overlay.active { display: block; }

        .suggestion-card {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .suggestion-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #3b82f6;
        }

        .news-card {
            background: #fff;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .news-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #3b82f6;
        }

        .sector-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .sector-badge.up { background: rgba(16,185,129,0.1); color: #10b981; }
        .sector-badge.down { background: rgba(239,68,68,0.1); color: #ef4444; }

        /* AI Chatbot Styles */
        .chatbot-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.3s;
            z-index: 2000;
        }
        .chatbot-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .chatbot-window {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 380px;
            height: 500px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 2000;
            overflow: hidden;
        }
        .chatbot-window.active { display: flex; }

        .chatbot-header {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            padding: 16px 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chatbot-header .avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .chatbot-header .info h4 { font-size: 16px; font-weight: 600; }
        .chatbot-header .info p { font-size: 12px; opacity: 0.9; }

        .chatbot-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }
        .message.bot {
            background: #f1f5f9;
            color: #1e293b;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        .message.user {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: #fff;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }

        .chatbot-input {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
        }
        .chatbot-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
        }
        .chatbot-input input:focus { border-color: #3b82f6; }
        .chatbot-input button {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .chatbot-input button:hover { transform: scale(1.1); }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 16px 12px;
        }
        .quick-action {
            padding: 8px 14px;
            background: #f1f5f9;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quick-action:hover { background: #3b82f6; color: #fff; }

        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-260px); }
            .main-panel { margin-left: 0; }
            .sidebar-open .sidebar { transform: translateX(0); }
            .chatbot-window { width: calc(100% - 48px); right: 24px; }
        }
    </style>
</head>
<body>
    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <div class="logo-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M3 3v18h18"/>
                    <path d="M18 9l-5-6-4 8-3-2"/>
                </svg>
            </div>
            <div>
                <div class="logo-text">Portfolio</div>
                <div class="logo-subtext">Investment Tracker</div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="sidebar-nav-item active" onclick="showSection('dashboard'); return false;">
                <span class="nav-icon"><i class="fas fa-th-large"></i></span>
                <span>Dashboard</span>
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showSection('portfolio'); return false;">
                <span class="nav-icon"><i class="fas fa-briefcase"></i></span>
                <span>My Portfolio</span>
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showSection('orders'); return false;">
                <span class="nav-icon"><i class="fas fa-clipboard-list"></i></span>
                <span>Orders</span>
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showSection('watchlist'); return false;">
                <span class="nav-icon"><i class="fas fa-star"></i></span>
                <span>Watchlist</span>
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showSection('market'); return false;">
                <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                <span>Market Data</span>
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showSection('transactions'); return false;">
                <span class="nav-icon"><i class="fas fa-exchange-alt"></i></span>
                <span>Transactions</span>
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showSection('analysis'); return false;">
                <span class="nav-icon"><i class="fas fa-chart-pie"></i></span>
                <span>Analysis</span>
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showSection('reports'); return false;">
                <span class="nav-icon"><i class="fas fa-file-alt"></i></span>
                <span>Reports</span>
            </a>
            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 12px;"></div>
            <a href="#" class="sidebar-nav-item" onclick="showSection('settings'); return false;">
                <span class="nav-icon"><i class="fas fa-cog"></i></span>
                <span>Settings</span>
            </a>
            <a href="#" class="sidebar-nav-item" onclick="toggleChatbot(); return false;">
                <span class="nav-icon"><i class="fas fa-robot"></i></span>
                <span>AI Assistant</span>
            </a>
        </nav>
    </div>

    <!-- Main Panel -->
    <div class="main-panel">
        <!-- Header -->
        <header style="background: #fff; padding: 16px 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <button onclick="toggleSidebar()" style="display: none; background: none; border: none; cursor: pointer; padding: 8px;">
                    <i class="fas fa-bars text-xl text-gray-600"></i>
                </button>
                <div class="search-box" style="width: 320px;">
                    <i class="fas fa-search text-gray-400"></i>
                    <input type="text" placeholder="Search stocks, portfolios..." id="globalSearch">
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="market-status open" id="marketStatus">
                    <span class="live-indicator"><i class="fas fa-circle text-xs"></i></span>
                    <span>Market Open</span>
                </div>

                <!-- Your Investment Summary -->
                <div id="yourInvestment" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 14px; cursor: pointer;" onclick="showSection('portfolio')">
                    <div class="stock-icon-circle small" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6);">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div>
                        <p style="color: #64748b; font-size: 11px;">Your Investment</p>
                        <p style="color: #1e293b; font-weight: 600; font-size: 14px;" id="yourInvestmentValue">$0.00</p>
                    </div>
                    <div id="investmentChange" style="font-size: 12px; font-weight: 600;">
                        <span class="gain-indicator up" id="investmentChangeIndicator">
                            <i class="fas fa-arrow-up"></i>
                            <span id="investmentChangePercent">0%</span>
                        </span>
                    </div>
                </div>

                <button style="position: relative; background: none; border: none; cursor: pointer; padding: 10px;" onclick="showNotifications()">
                    <div class="stock-icon-circle small" style="background: #f1f5f9; color: #64748b;">
                        <i class="fas fa-bell"></i>
                    </div>
                    <span style="position: absolute; top: 2px; right: 2px; background: #ef4444; color: #fff; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">3</span>
                </button>
                <button style="background: none; border: none; cursor: pointer; padding: 10px;" onclick="refreshAllData()">
                    <div class="stock-icon-circle small" style="background: #f1f5f9; color: #64748b;">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                </button>
                <div class="stock-icon-circle small" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); cursor: pointer;" onclick="showSection('settings')">
                    <span style="font-size: 12px;">PM</span>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div style="padding: 24px;">
            <!-- Top Stock Gainers as Suggestions -->
            <div class="stat-card" style="margin-bottom: 24px;" id="section-suggestions">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 class="section-title">
                        <i class="fas fa-fire text-orange-500 mr-2"></i>Top Gainers Today
                    </h3>
                    <button onclick="refreshSuggestions()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="topGainersSuggestions" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                    <!-- Top gainers will be loaded here -->
                </div>
            </div>

            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px;" id="section-stats">
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">Total Portfolio Value</p>
                            <h3 style="font-size: 28px; font-weight: 700; color: #1e293b;" id="totalValue">$0.00</h3>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.05)); color: #3b82f6;">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
                        <span class="gain-indicator up" id="totalGainIndicator">
                            <i class="fas fa-arrow-up"></i>
                            <span id="totalGainPercent">0%</span>
                        </span>
                        <span style="color: #64748b; font-size: 13px;">vs last month</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">Total Investment</p>
                            <h3 style="font-size: 28px; font-weight: 700; color: #1e293b;" id="totalInvestment">$0.00</h3>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05)); color: #10b981;">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <span style="color: #64748b; font-size: 13px;">Original capital invested</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">Total Gain/Loss</p>
                            <h3 style="font-size: 28px; font-weight: 700;" id="totalGainLoss">$0.00</h3>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05)); color: #8b5cf6;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <span style="color: #64748b; font-size: 13px;">Overall performance</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <p style="color: #64748b; font-size: 13px; margin-bottom: 4px;">Holdings</p>
                            <h3 style="font-size: 28px; font-weight: 700; color: #1e293b;" id="totalItems">0</h3>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05)); color: #f59e0b;">
                            <i class="fas fa-layer-group"></i>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <span style="color: #64748b; font-size: 13px;">Active positions</span>
                    </div>
                </div>
            </div>

            <!-- Market Movers & Sectors Trending -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;" id="section-market">
                <!-- Top Market Movers -->
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title">
                            <i class="fas fa-rocket text-blue-500 mr-2"></i>Market Movers
                        </h3>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border-radius: 12px; padding: 16px;">
                            <p style="color: #10b981; font-size: 12px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-arrow-up"></i> Top Gainers
                            </p>
                            <div id="topGainers" style="max-height: 180px; overflow-y: auto;">
                                <!-- Top gainers will be loaded here -->
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(239,68,68,0.05)); border-radius: 12px; padding: 16px;">
                            <p style="color: #ef4444; font-size: 12px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-arrow-down"></i> Top Losers
                            </p>
                            <div id="topLosers" style="max-height: 180px; overflow-y: auto;">
                                <!-- Top losers will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sectors Trending Today -->
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title">
                            <i class="fas fa-chart-bar text-purple-500 mr-2"></i>Sectors Trending
                        </h3>
                    </div>
                    <div id="sectorsTrending" style="max-height: 300px; overflow-y: auto;">
                        <!-- Sectors will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px;" id="section-charts">
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title">Portfolio Performance</h3>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="updateChartPeriod('1D')" class="period-btn active" style="padding: 8px 16px; border: none; border-radius: 8px; background: #3b82f6; color: #fff; cursor: pointer; font-size: 12px; font-weight: 500;">1D</button>
                            <button onclick="updateChartPeriod('1W')" class="period-btn" style="padding: 8px 16px; border: none; border-radius: 8px; background: #e2e8f0; color: #64748b; cursor: pointer; font-size: 12px; font-weight: 500;">1W</button>
                            <button onclick="updateChartPeriod('1M')" class="period-btn" style="padding: 8px 16px; border: none; border-radius: 8px; background: #e2e8f0; color: #64748b; cursor: pointer; font-size: 12px; font-weight: 500;">1M</button>
                            <button onclick="updateChartPeriod('1Y')" class="period-btn" style="padding: 8px 16px; border: none; border-radius: 8px; background: #e2e8f0; color: #64748b; cursor: pointer; font-size: 12px; font-weight: 500;">1Y</button>
                        </div>
                    </div>
                    <div style="height: 280px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <div class="stat-card">
                    <h3 class="section-title" style="margin-bottom: 16px;">Asset Allocation</h3>
                    <div style="height: 280px;">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stocks in News & Market Data -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px;" id="section-news">
                <!-- Stocks in News -->
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title">
                            <i class="fas fa-newspaper text-orange-500 mr-2"></i>Stocks in News
                        </h3>
                        <button onclick="refreshNews()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div id="stocksInNews" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                        <!-- News articles will be loaded here -->
                    </div>
                </div>

                <!-- Market Data -->
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title">Live Market</h3>
                        <button onclick="refreshMarketData()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div id="marketDataList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Market data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Portfolio Holdings -->
            <div class="stat-card" style="margin-bottom: 24px;" id="section-portfolio">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 class="section-title">Portfolio Holdings</h3>
                    <button onclick="showAddModal()" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plus"></i> Add Position
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px 8px; text-align: left; font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">Stock</th>
                                <th style="padding: 12px 8px; text-align: right; font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">Price</th>
                                <th style="padding: 12px 8px; text-align: right; font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">Change</th>
                                <th style="padding: 12px 8px; text-align: right; font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">Value</th>
                                <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioTableBody">
                            <!-- Portfolio data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders & Watchlist -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;" id="section-orders">
                <!-- Recent Orders -->
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title">
                            <i class="fas fa-clipboard-list text-green-500 mr-2"></i>Recent Orders
                        </h3>
                        <button onclick="scrollToSection('section-orders')" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 13px; font-weight: 500;">View All</button>
                    </div>
                    <div id="ordersList" style="max-height: 250px; overflow-y: auto;">
                        <!-- Orders will be loaded here -->
                    </div>
                </div>

                <!-- Watchlist -->
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>Watchlist
                        </h3>
                        <button onclick="addToWatchlist()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div id="watchlistData" style="max-height: 250px; overflow-y: auto;">
                        <!-- Watchlist data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- API Documentation Link -->
            <div class="stat-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 class="section-title">API Documentation</h3>
                        <p style="color: #64748b; font-size: 14px; margin-top: 4px;">Interactive API docs powered by Swagger UI</p>
                    </div>
                    <a href="/swagger-ui.html" target="_blank" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: #fff; text-decoration: none; padding: 12px 24px; border-radius: 10px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-book"></i> Open Swagger UI
                    </a>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer style="background: #fff; padding: 20px 24px; border-top: 1px solid #e2e8f0; margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div style="color: #64748b; font-size: 13px;">
                    Portfolio Manager v1.0.0 - Financial Portfolio Tracking System
                </div>
                <div style="display: flex; gap: 24px;">
                    <a href="/swagger-ui.html" style="color: #3b82f6; text-decoration: none; font-size: 13px;">API Docs</a>
                    <a href="#" style="color: #64748b; text-decoration: none; font-size: 13px;">Privacy</a>
                    <a href="#" style="color: #64748b; text-decoration: none; font-size: 13px;">Terms</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- AI Chatbot Button -->
    <div class="chatbot-button" onclick="toggleChatbot()">
        <i class="fas fa-robot"></i>
    </div>

    <!-- AI Chatbot Window -->
    <div class="chatbot-window" id="chatbotWindow">
        <div class="chatbot-header">
            <div class="avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="info">
                <h4>AI Investment Assistant</h4>
                <p>Ask me anything about your portfolio</p>
            </div>
            <button onclick="toggleChatbot()" style="background: none; border: none; color: #fff; cursor: pointer; margin-left: auto; font-size: 18px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <!-- Messages will be loaded here -->
        </div>
        <div class="quick-actions" id="quickActions">
            <button class="quick-action" onclick="sendQuickMessage('Suggest good stocks to invest')">Suggest stocks</button>
            <button class="quick-action" onclick="sendQuickMessage('Analyze my portfolio')">Analyze portfolio</button>
            <button class="quick-action" onclick="sendQuickMessage('What are top gainers today')">Top gainers</button>
            <button class="quick-action" onclick="sendQuickMessage('How to diversify my portfolio')">Diversification</button>
        </div>
        <div class="chatbot-input">
            <input type="text" id="chatbotInput" placeholder="Ask about stocks, investments..." onkeypress="handleChatbotKeypress(event)">
            <button onclick="sendChatbotMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Add/Edit Position Modal -->
    <div id="positionModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000;">
        <div style="background: #fff; border-radius: 20px; padding: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 20px; font-weight: 600; color: #1e293b;" id="modalTitle">Add New Position</h3>
                <button onclick="closeModal()" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #64748b; padding: 8px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="positionForm" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="positionId">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;">Stock Symbol *</label>
                    <input type="text" id="stockSymbol" required placeholder="e.g., AAPL, GOOGL, MSFT" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#3b82f6'">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;">Company Name *</label>
                    <input type="text" id="companyName" required placeholder="e.g., Apple Inc." style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#3b82f6'">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;">Asset Type *</label>
                    <select id="assetType" required style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#3b82f6'">
                        <option value="">Select type...</option>
                        <option value="STOCK">Stock</option>
                        <option value="ETF">ETF</option>
                        <option value="MUTUAL_FUND">Mutual Fund</option>
                        <option value="BOND">Bond</option>
                        <option value="CRYPTO">Cryptocurrency</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;">Quantity *</label>
                        <input type="number" id="quantity" required min="0" step="0.0001" placeholder="0" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#3b82f6'">
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;">Purchase Price *</label>
                        <input type="number" id="purchasePrice" required min="0" step="0.01" placeholder="$0.00" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#3b82f6'">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;">Current Price</label>
                        <input type="number" id="currentPrice" min="0" step="0.01" placeholder="$0.00" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#3b82f6'">
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;">Purchase Date</label>
                        <input type="date" id="purchaseDate" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#3b82f6'">
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;">Notes</label>
                    <textarea id="notes" rows="2" placeholder="Optional notes..." style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#3b82f6'"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal()" style="padding: 12px 24px; border: 2px solid #e2e8f0; border-radius: 10px; background: #fff; color: #64748b; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s;">Cancel</button>
                    <button type="submit" style="padding: 12px 24px; border: none; border-radius: 10px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: #fff; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s;">
                        <i class="fas fa-save"></i> Save Position
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" style="position: fixed; bottom: 24px; right: 24px; background: #1e293b; color: #fff; padding: 16px 24px; border-radius: 12px; display: none; align-items: center; gap: 12px; z-index: 3000; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
        <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
        <span id="toastMessage">Success!</span>
    </div>

    <script src="/js/app.js"></script>

<script>
/**
 * Iframe 元素高亮注入脚本
 * 需要在目标网站中引入此脚本来支持跨域 iframe 高亮功能
 *
 * 使用方法：
 * 1. 将此脚本添加到目标网站的 HTML 中
 * 2. 或通过浏览器扩展、用户脚本等方式注入
 */

(function () {
  "use strict";

  // 检查是否在 iframe 中
  if (window.self === window.top) {
    return; // 不在 iframe 中，不执行
  }

  // 检查是否已经初始化过
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe 高亮脚本已加载");

  // 创建高亮覆盖层
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // 创建悬停高亮框（虚线边框）
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // 创建选中节点的常驻高亮框（实线边框）
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // 创建悬停标签显示
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // 创建选中节点标签
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // 存储当前选中的元素
  var selectedElement = null;
  var highlightEnabled = false;

  // 更新选中元素的高亮显示
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // 更新选中高亮框位置
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // 更新选中标签位置和内容
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    var labelWidth = selectedLabel.offsetWidth || 100; // 预估宽度
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // 优先检查唯一ID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // ID唯一，无需继续向上
      }

      // 生成类名选择器（取第一个有效类名）
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // 生成位置索引（nth-child）
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // 处理根元素
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // 获取元素文本内容
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // 获取元素属性信息
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // 鼠标悬停事件处理
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免高亮 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 如果是已选中的元素，不显示悬停高亮
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // 更新悬停高亮框位置
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // 更新标签位置和内容
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // 发送消息到父窗口
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 鼠标离开事件处理
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // 如果鼠标移动到高亮相关元素上，不隐藏高亮
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 点击事件处理
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免处理 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 检查是否是交互元素，这些元素需要保留默认行为
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // 如果高亮功能启用，对于非交互元素阻止默认行为和事件传播
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // 立即更新选中高亮
    updateSelectedHighlight(target);

    // 隐藏悬停高亮，因为现在是选中状态
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 监听来自父窗口的消息
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // 启用高亮功能
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // 禁用高亮功能
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // 保持事件监听器，但通过 highlightEnabled 变量控制行为
    // 这样可以保留选中状态的显示
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // 不隐藏 selectedBox 和 selectedLabel，保留选中状态
  }

  // 完全禁用高亮功能（移除所有监听器）
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // 添加事件监听
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // 暴露全局函数供外部调用
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // 通过消息发送开关控制
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // 通知父窗口脚本已加载
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("无法发送就绪消息到父窗口:", error);
  }

  // 清理函数
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();

</script>
</body>
</html>
